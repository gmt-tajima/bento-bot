// ===============================
// â‘  Expressï¼ˆRender keep-aliveï¼‰
// ===============================
const express = require("express");
const app = express();
const PORT = process.env.PORT || 3000;

app.get("/", (req, res) => {
  res.send("Bot is running");
});

app.listen(PORT, () => {
  console.log(`Keep-alive server running on port ${PORT}`);
});

// ===============================
// â‘¡ Discord Bot æœ¬ä½“
// ===============================
const { Client, GatewayIntentBits, Partials } = require("discord.js");
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.GuildMessageReactions,
    GatewayIntentBits.MessageContent
  ],
  partials: [Partials.Message, Partials.Reaction, Partials.User]
});

// ===============================
// â‘¢ Google Sheets API
// ===============================
const { google } = require("googleapis");
const sheets = google.sheets("v4");

let todayMessageId = null;
let deadlineTime = null;
let deadlineCheck = "ON";

// ===============================
// è¨±å¯ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
// ===============================
const ALLOWED_REACTIONS = ["ðŸ±", "ðŸš", "âŒ"];

// ===============================
// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
// ===============================
function getTodayDateString() {
  const d = new Date();
  const y = d.getFullYear();
  const m = ("0" + (d.getMonth() + 1)).slice(-2);
  const day = ("0" + d.getDate()).slice(-2);
  return `${y}/${m}/${day}`;
}

// ===============================
// â˜… ç· åˆ‡è¨­å®šã‚’æ¯Žå›žå–å¾—ã™ã‚‹é–¢æ•°
// ===============================
async function loadDeadlineSettings() {
  const auth = new google.auth.GoogleAuth({
    credentials: JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT),
    scopes: ["https://www.googleapis.com/auth/spreadsheets"]
  });
  const sheetsClient = await auth.getClient();
  const sheetsApi = google.sheets({ version: "v4", auth: sheetsClient });

  const settingsSheet = await sheetsApi.spreadsheets.values.get({
    auth: sheetsClient,
    spreadsheetId: process.env.SHEET_ID,
    range: "è¨­å®š!A1:B20"
  });

  const settingsRows = settingsSheet.data.values;

  function getSetting(name) {
    const row = settingsRows.find(r => r[0] === name);
    return row ? row[1] : null;
  }

  const fixedDeadline = getSetting("ç· åˆ‡å›ºå®šãƒ¢ãƒ¼ãƒ‰");
  const deadlineMode = getSetting("ç· åˆ‡ãƒ¢ãƒ¼ãƒ‰");
  const deadlineCheckSetting = getSetting("ç· åˆ‡ãƒã‚§ãƒƒã‚¯");
  const optionalMinutes = getSetting("ç· åˆ‡ä»»æ„ãƒ¢ãƒ¼ãƒ‰");

  let deadlineTime;

  if (deadlineMode === "å›ºå®š") {
    deadlineTime = fixedDeadline;
  } else {
    const postTime = getSetting("æŠ•ç¨¿æ™‚é–“");
    const [ph, pm] = postTime.split(":").map(Number);
    const base = new Date();
    base.setHours(ph);
    base.setMinutes(pm);
    base.setSeconds(0);

    const addMinutes = parseFloat(optionalMinutes) * 60;
    base.setMinutes(base.getMinutes() + addMinutes);

    const hh = String(base.getHours()).padStart(2, "0");
    const mm = String(base.getMinutes()).padStart(2, "0");
    deadlineTime = `${hh}:${mm}`;
  }

  return {
    deadlineTime,
    deadlineCheck: deadlineCheckSetting
  };
}

// ===============================
// â‘£ Bot èµ·å‹•æ™‚
// ===============================
client.once("ready", () => {
  console.log(`Bot èµ·å‹•: ${client.user.tag}`);
  initializeTodayMessage();
  fetchTodayMessageFromChannel();
});

// ===============================
// â˜… æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæŠ•ç¨¿ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
// ===============================
client.on("messageCreate", async (message) => {
  try {
    if (message.author.bot && (!message.embeds || message.embeds.length === 0)) return;
    if (!message.embeds || message.embeds.length === 0) return;

    const embed = message.embeds[0];
    const title = embed?.title || "";

    const today = getTodayDateString();
    const [year, month, day] = today.split("/");

    const key1 = `${parseInt(year)}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
    const key2 = `${String(year).slice(-2)}å¹´${month}${day}æ—¥`;
    const key3 = `${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;

    const isTodayPost =
      title.includes(key1) ||
      title.includes(key2) ||
      title.includes(key3);

    if (!isTodayPost) return;

    todayMessageId = message.id;

    if (deadlineCheck === "ON" && isAfterDeadline()) {
      await message.reply("âš  ç· åˆ‡æ™‚é–“ã‚’éŽãŽã¦ã„ã‚‹ãŸã‚ã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å—ä»˜ã§ãã¾ã›ã‚“");
      return;
    }

    await writeTodayMessageIdToSheet(todayMessageId);

    await message.react("ðŸ±");
    await message.react("ðŸš");
    await message.react("âŒ");

  } catch (err) {
    console.error("messageCreate ã‚¨ãƒ©ãƒ¼:", err);
  }
});

// ===============================
// â‘¤ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆæ³¨æ–‡ï¼‰
// ===============================
client.on("messageReactionAdd", async (reaction, user) => {
  try {
    if (user.bot) return;
    if (reaction.message.id !== todayMessageId) return;

    if (reaction.partial) await reaction.fetch().catch(() => {});
    if (reaction.message.partial) await reaction.message.fetch().catch(() => {});

    // â˜… ç· åˆ‡è¨­å®šã‚’æ¯Žå›žå–å¾—
    ({ deadlineCheck, deadlineTime } = await loadDeadlineSettings());

    if (deadlineCheck === "ON" && isAfterDeadline()) {
      await reaction.users.remove(user.id).catch(() => {});

      const msg = await reaction.message.reply({
        content: `<@${user.id}> âš  ç· åˆ‡æ™‚é–“ã‚’éŽãŽã¦ã„ã‚‹ãŸã‚ã€æ³¨æ–‡ã¯å—ä»˜ã§ãã¾ã›ã‚“`,
        allowedMentions: { users: [user.id] }
      }).catch(() => {});

      setTimeout(() => {
        msg.delete().catch(() => {});
      }, 3000);

      return;
    }

    await handleReactionAdd(reaction, user);

  } catch (err) {
    console.error("messageReactionAdd ã‚¨ãƒ©ãƒ¼:", err);
  }
});

// ===============================
// â‘¥ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
// ===============================
client.on("messageReactionRemove", async (reaction, user) => {
  try {
    if (user.bot) return;
    if (reaction.message.id !== todayMessageId) return;

    if (reaction.partial) await reaction.fetch().catch(() => {});
    if (reaction.message.partial) await reaction.message.fetch().catch(() => {});

    // â˜… ç· åˆ‡è¨­å®šã‚’æ¯Žå›žå–å¾—
    ({ deadlineCheck, deadlineTime } = await loadDeadlineSettings());

    if (deadlineCheck === "ON" && isAfterDeadline()) {
      await reaction.message.react(reaction.emoji.name).catch(() => {});

      const msg = await reaction.message.reply({
        content: `<@${user.id}> âš  ç· åˆ‡å¾Œã®ãŸã‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã¾ã›ã‚“`,
        allowedMentions: { users: [user.id] }
      }).catch(() => {});

      setTimeout(() => {
        msg.delete().catch(() => {});
      }, 3000);

      return;
    }

    await handleReactionRemove(reaction, user);

  } catch (err) {
    console.error("messageReactionRemove ã‚¨ãƒ©ãƒ¼:", err);
  }
});