// ===============================
// â‘  Expressï¼ˆRender keep-aliveï¼‰
// ===============================
const express = require("express");
const app = express();
const PORT = process.env.PORT || 3000;

app.get("/", (req, res) => {
  res.send("Bot is running");
});

app.listen(PORT, () => {
  console.log(`Keep-alive server running on port ${PORT}`);
});

// ===============================
// â‘¡ Discord Bot æœ¬ä½“
// ===============================
const { Client, GatewayIntentBits, Partials } = require("discord.js");
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.GuildMessageReactions,
    GatewayIntentBits.MessageContent
  ],
  partials: [Partials.Message, Partials.Reaction, Partials.User]
});

// ===============================
// â‘¢ Google Sheets API
// ===============================
const { google } = require("googleapis");
const sheets = google.sheets("v4");

let todayMessageId = null;
let deadlineTime = null;
let deadlineCheck = "ON";

// ===============================
// è¨±å¯ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
// ===============================
const ALLOWED_REACTIONS = ["ğŸ±", "ğŸš", "âŒ"];

// ===============================
// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
// ===============================
function getTodayDateString() {
  const d = new Date();
  const y = d.getFullYear();
  const m = ("0" + (d.getMonth() + 1)).slice(-2);
  const day = ("0" + d.getDate()).slice(-2);
  return `${y}/${m}/${day}`;
}

// ===============================
// â‘£ Bot èµ·å‹•æ™‚
// ===============================
client.once("ready", () => {
  console.log(`Bot èµ·å‹•: ${client.user.tag}`);
  initializeTodayMessage();
  fetchTodayMessageFromChannel();   // æœ€æ–°æŠ•ç¨¿ã‹ã‚‰æŠ•ç¨¿IDã‚’å–å¾—
});

// ===============================
// â‘¤ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
// ===============================
client.on("messageReactionAdd", async (reaction, user) => {
  handleReactionAdd(reaction, user);
});

// ===============================
// â‘¥ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤
// ===============================
client.on("messageReactionRemove", async (reaction, user) => {
  handleReactionRemove(reaction, user);
});

// ===============================
// Discord æ¥ç¶šçŠ¶æ…‹ãƒ­ã‚°
// ===============================
client.on("error", (err) => {
  console.error("Discord ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼:", err);
});

client.on("shardDisconnect", (event, id) => {
  console.log(`Shard ${id} disconnected`, event);
});

client.on("shardReconnecting", (id) => {
  console.log(`Shard ${id} reconnecting`);
});

client.on("shardResume", (id, replayed) => {
  console.log(`Shard ${id} resumed. Replayed events: ${replayed}`);
});

// ===============================
// â‘¦ Bot ãƒ­ã‚°ã‚¤ãƒ³
// ===============================
client.login(process.env.DISCORD_TOKEN);

// ===============================
// Node.js ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ¤œçŸ¥
// ===============================
process.on("unhandledRejection", (reason, promise) => {
  console.error("Unhandled Rejection at:", promise, "reason:", reason);
});

process.on("uncaughtException", (err) => {
  console.error("Uncaught Exception:", err);
});

// =======================================================
// ã“ã“ã‹ã‚‰ä¸‹ãŒ 6ã¤ã®é–¢æ•°ï¼ˆRenderç‰ˆï¼‰
// =======================================================

// ===============================
// ä»Šæ—¥ã®æŠ•ç¨¿IDãƒ»ç· åˆ‡æƒ…å ±ã‚’å–å¾—
// ===============================
async function initializeTodayMessage() {
  try {
    const auth = new google.auth.GoogleAuth({
      credentials: JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT),
      scopes: ["https://www.googleapis.com/auth/spreadsheets"]
    });
    const sheetsClient = await auth.getClient();   // â† ä¿®æ­£ï¼šclient ã‚’ä¸Šæ›¸ãã—ãªã„

    const postLog = await sheets.spreadsheets.values.get({
      auth: sheetsClient,
      spreadsheetId: process.env.SHEET_ID,
      range: "æŠ•ç¨¿ãƒ­ã‚°!A:C"
    });

    const rows = postLog.data.values;
    if (!rows) return;

    const today = getTodayDateString();

    for (let i = rows.length - 1; i >= 0; i--) {
      if (rows[i][0] === today) {
        todayMessageId = rows[i][1];
        break;
      }
    }

    console.log("ä»Šæ—¥ã®æŠ•ç¨¿ID:", todayMessageId);

    const settings = await sheets.spreadsheets.values.get({
      auth: sheetsClient,
      spreadsheetId: process.env.SHEET_ID,
      range: "è¨­å®š!B1:B6"
    });

    const v = settings.data.values.map(r => r[0]);

    deadlineTime = v[2];
    deadlineCheck = v[4];

    console.log("ç· åˆ‡æ™‚åˆ»:", deadlineTime);
    console.log("ç· åˆ‡ãƒã‚§ãƒƒã‚¯:", deadlineCheck);

  } catch (err) {
    console.error("initializeTodayMessage ã‚¨ãƒ©ãƒ¼:", err);
  }
}