// ===============================
// â˜…â‘¢ æœ€æ–°æŠ•ç¨¿ã‹ã‚‰ä»Šæ—¥ã®æŠ•ç¨¿IDã‚’å–å¾—ï¼ˆå¹´å…¥ã‚Šã‚¿ã‚¤ãƒˆãƒ«å¯¾å¿œç‰ˆï¼‰
// ===============================
async function fetchTodayMessageFromChannel() {
  try {
    const channel = await client.channels.fetch(process.env.CHANNEL_ID);
    if (!channel) {
      console.error("ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }

    const messages = await channel.messages.fetch({ limit: 1 });
    const latest = messages.first();
    if (!latest) {
      console.log("æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
      return;
    }

    const today = getTodayDateString(); // 2026/01/16
    const [year, month, day] = today.split("/");

    // åˆ¤å®šã‚­ãƒ¼ã‚’è¤‡æ•°ç”¨æ„ï¼ˆGAS ã®ã‚¿ã‚¤ãƒˆãƒ«æºã‚Œã«å¯¾å¿œï¼‰
    const key1 = `${parseInt(year)}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`; // 2026å¹´1æœˆ16æ—¥
    const key2 = `${String(year).slice(-2)}å¹´${month}${day}æ—¥`;              // 26å¹´01æœˆ16æ—¥
    const key3 = `${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;                   // 1æœˆ16æ—¥ï¼ˆæ—§å½¢å¼ï¼‰

    const embed = latest.embeds[0];
    const title = embed?.title || "";

    // ã©ã‚Œã‹1ã¤ã§ã‚‚å«ã¾ã‚Œã¦ã„ã‚Œã°ã€Œä»Šæ—¥ã®æŠ•ç¨¿ã€ã¨åˆ¤å®š
    const isTodayPost =
      title.includes(key1) ||
      title.includes(key2) ||
      title.includes(key3);

    if (!isTodayPost) {
      console.log(`ä»Šæ—¥ã®æŠ•ç¨¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸ä¸€è‡´ï¼‰ title="${title}"`);
      console.log(`æœŸå¾…ã‚­ãƒ¼: ${key1} / ${key2} / ${key3}`);
      return;
    }

    // ä»Šæ—¥ã®æŠ•ç¨¿IDã‚’ã‚»ãƒƒãƒˆ
    todayMessageId = latest.id;
    console.log("æœ€æ–°æŠ•ç¨¿ã‹ã‚‰å–å¾—ã—ãŸæŠ•ç¨¿ID:", todayMessageId);

    // æŠ•ç¨¿ãƒ­ã‚°ã¸æ›¸ãè¾¼ã¿
    await writeTodayMessageIdToSheet(todayMessageId);

    // Bot ãŒãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹
    await latest.react("ğŸ±");
    await latest.react("ğŸš");
    await latest.react("âŒ");

  } catch (err) {
    console.error("fetchTodayMessageFromChannel ã‚¨ãƒ©ãƒ¼:", err);
  }
}

// ===============================
// â˜…â‘¢ æŠ•ç¨¿IDã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
// ===============================
async function writeTodayMessageIdToSheet(messageId) {
  try {
    const auth = new google.auth.GoogleAuth({
      credentials: JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT),
      scopes: ["https://www.googleapis.com/auth/spreadsheets"]
    });
    const sheetsClient = await auth.getClient();

    const today = getTodayDateString();

    // æŠ•ç¨¿ãƒ­ã‚°ã‚’å–å¾—ã—ã¦é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const postLog = await sheets.spreadsheets.values.get({
      auth: sheetsClient,
      spreadsheetId: process.env.SHEET_ID,
      range: "æŠ•ç¨¿ãƒ­ã‚°!A:C"
    });

    const rows = postLog.data.values || [];
    const alreadyExists = rows.some(row => row[0] === today && row[1] === messageId);
    if (alreadyExists) {
      console.log("æŠ•ç¨¿IDã¯æ—¢ã«è¨˜éŒ²æ¸ˆã¿ã®ãŸã‚ã€æ›¸ãè¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™");
      return;
    }

    await sheets.spreadsheets.values.append({
      auth: sheetsClient,
      spreadsheetId: process.env.SHEET_ID,
      range: "æŠ•ç¨¿ãƒ­ã‚°!A:C",
      valueInputOption: "USER_ENTERED",
      requestBody: {
        values: [[today, messageId, "Botè‡ªå‹•å–å¾—"]]
      }
    });

    console.log("æŠ•ç¨¿IDã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿:", messageId);

  } catch (err) {
    console.error("writeTodayMessageIdToSheet ã‚¨ãƒ©ãƒ¼:", err);
  }
}

// ===============================
// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆæ³¨æ–‡ï¼‰
// ===============================
async function handleReactionAdd(reaction, user) {
  try {
    if (user.bot) return;

    if (reaction.partial) {
      try { await reaction.fetch(); } catch {}
    }
    if (reaction.message.partial) {
      try { await reaction.message.fetch(); } catch {}
    }

    if (reaction.message.id !== todayMessageId) return;

    const emoji = reaction.emoji.name;

    if (!ALLOWED_REACTIONS.includes(emoji)) {
      await reaction.users.remove(user.id);
      return;
    }

    if (emoji === "âŒ") return;

    if (deadlineCheck === "ON" && isAfterDeadline()) {
      await reaction.users.remove(user.id);
      await user.send("ç· åˆ‡å¾Œã®ãŸã‚æ³¨æ–‡ã§ãã¾ã›ã‚“");
      return;
    }

    const member = await findMember(user.id);
    if (!member) {
      await user.send("åç°¿ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç·å‹™ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    await writeReactionLog({
      discordId: user.id,
      name: member.name,
      internalId: member.internalId,
      place: member.place,
      type: emoji,
      status: deadlineCheck === "OFF" ? "ç‰¹åˆ¥å—ä»˜" : "æ³¨æ–‡"
    });

  } catch (err) {
    console.error("handleReactionAdd ã‚¨ãƒ©ãƒ¼:", err);
  }
}